import {
  to = segment_reverse_etl_model.id-kjA4y9xwNDsJ3nbhvx1ynE
  id = "kjA4y9xwNDsJ3nbhvx1ynE"
}

resource "segment_reverse_etl_model" "id-kjA4y9xwNDsJ3nbhvx1ynE" {
  description             = " "
  enabled                 = true
  name                    = "snowflake-website-events-cosmos"
  query                   = "WITH\n    EMAILS AS (\n        SELECT 4 AS ID, 'srinivas.chevali@drivetime.com' AS EMAIL\n        UNION\n        SELECT 2, 'Aaron.Mciver@drivetime.com'\n        UNION\n        SELECT 3, 'Joseph.jacobs1@Drivetime.com'\n        UNION\n        SELECT 1, 'srinivas.chevali@gmail.com'\n        UNION\n        SELECT 0, 'Joseph.jacobs1@Drivetime.com'\n    ),\n    DISTINCT_PERSONS AS (\n          SELECT DISTINCT MASTERPERSONID::INT AS MASTERPERSONID\n          FROM MARKETING_RAW.WEBSITE.COSMOS_DATA_FLAT F\n          WHERE MASTERPERSONID::INT > 0\n    ),\n    PERSON_BUCKETS AS\n         (SELECT MASTERPERSONID::INT AS MASTERPERSONID, NTILE(100) OVER (ORDER BY MASTERPERSONID::INT) AS BUCKET\n          FROM DISTINCT_PERSONS\n         ),\n    RAW_DATA AS (\n        SELECT  DISTINCT\n                BUCKET,\n                MP.PERSONID,\n                COALESCE(P.ISDONOTCONTACT,'FALSE') AS PERSON_DNC,\n                EVENTDATETIME,\n                UPPER(REPLACE(FORMNAME, 'mobile/','')) AS FORMNAME,\n                F.FIRSTNAME,\n                F.LASTNAME,\n                F.SOCIALSECURITYNUMBER,\n                UUID_STRING('1aae866a-f1a1-3333-9c8d-72a7adae5f67', MD5(F.SOCIALSECURITYNUMBER)) AS USER_ID,\n                F.DATEOFBIRTH,\n                F.PHONENUMBER AS STATED_PHONE,\n                F.PHONENUMBER AS CONTACTABLE_PHONE,\n                COALESCE(PP.ISPREFERRED,'FALSE') AS CONTACTABLE_PHONE_PREFERRED,\n                COALESCE(PP.ISDONOTCONTACT,'FALSE') AS CONTACTABLE_PHONE_DNC,\n                E.EMAIL AS STATED_EMAIL,\n                E.EMAIL AS CONTACTABLE_EMAIL,\n                COALESCE(PE.ISPREFERRED,'FALSE') AS CONTACTABLE_EMAIL_PREFERRED,\n                COALESCE(PE.ISDONOTCONTACT,'FALSE') AS CONTACTABLE_EMAIL_DNC,\n                OBJECT_CONSTRUCT('Street', COALESCE(address_STREET,''), 'City',  COALESCE(address_CITY,''), 'State',  COALESCE(address_STATE,''), 'postalCode', COALESCE(address_ZIP,'')) AS ADDRESS,\n                address_STREET,\n                address_CITY,\n                address_STATE,\n                address_ZIP AS POSTAL_CODE,\n                CASE WHEN P.SEXTYPEID = 3 THEN 'M' WHEN P.SEXTYPEID = 1 THEN 'F' END AS GENDER,\n                CASE WHEN P.ISSPANISH THEN 'es' WHEN NOT ISSPANISH THEN 'en' END AS LANGUAGE\n        FROM MARKETING_RAW.WEBSITE.COSMOS_DATA_FLAT F\n        INNER JOIN PERSON_BUCKETS PB ON F.MASTERPERSONID::INT = PB.MASTERPERSONID\n        LEFT OUTER JOIN REPLICATED.RETAILPERSON.DBO_TBLMASTERPERSON MP ON MP.MASTERPERSONID = F.MASTERPERSONID\n        LEFT OUTER JOIN EMAILS E ON E.ID = MP.PERSONID % 4\n        LEFT OUTER JOIN REPLICATED.RETAILPERSON.DBO_TBLPERSON P ON P.PERSONID = MP.PERSONID\n        LEFT OUTER JOIN REPLICATED.RETAILPERSON.DBO_TBLPERSONPHONE PP ON PP.PERSONID = MP.PERSONID AND UPPER(PP.PHONENUMBER) = UPPER(F.PHONENUMBER)\n        LEFT OUTER JOIN REPLICATED.RETAILPERSON.DBO_TBLPERSONEMAIL PE ON PE.PERSONID = MP.PERSONID AND UPPER(PE.EMAILADDRESS) = UPPER(F.EMAILADDRESS)\n        WHERE PB.BUCKET = 6 AND MP.PERSONID IS NOT NULL\n        )\n    SELECT TOP 15 BUCKET*100000000 + ROW_NUMBER() OVER (ORDER BY 1) AS ID, *\n    FROM RAW_DATA\n    ORDER BY PERSONID, EVENTDATETIME;"
  query_identifier_column = "id"
  schedule_config         = jsonencode({})
  schedule_strategy       = ""
  source_id               = "wnHJxvT3a6m8gEdywCKkLW"
}