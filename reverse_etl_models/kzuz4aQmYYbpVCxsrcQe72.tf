import {
  to = segment_reverse_etl_model.id-kzuz4aQmYYbpVCxsrcQe72
  id = "kzuz4aQmYYbpVCxsrcQe72"
}

resource "segment_reverse_etl_model" "id-kzuz4aQmYYbpVCxsrcQe72" {
  description             = "Programatically generated rETL model that is associated with an Engage rETL audience"
  enabled                 = true
  name                    = "Update Braze Audience"
  query                   = "WITH ID_GRAPH AS (\n\tSELECT \n\t\t\"CANONICAL_SEGMENT_ID\", \n\t\t\"SEGMENT_ID\"\n\tFROM \"SEGMENT_EVENTS\".\"DRIVETIME_PROFILE\".\"PROFILE_MERGES\"\n), EXTERNAL_ID_MAPPING AS (\n\tSELECT\n\t\tids.\"CANONICAL_SEGMENT_ID\" as \"CANONICAL_SEGMENT_ID\", \n\t\t\"TYPE\" as \"EXTERNAL_ID_TYPE\",\n\t\t\"VALUE\" as \"EXTERNAL_ID_VALUE\"\n\tFROM \"SEGMENT_EVENTS\".\"DRIVETIME_PROFILE\".\"USER_IDENTIFIERS\" AS ids\n\tINNER JOIN ID_GRAPH AS ig\n\t\tON ig.\"CANONICAL_SEGMENT_ID\" = ids.\"CANONICAL_SEGMENT_ID\"\n\tWHERE \"TYPE\" IN ('android.idfa','email','ios.idfa','phone','user_id')\n), PROFILE_TRAITS AS (\n\tSELECT \n\t\tsids.\"CANONICAL_SEGMENT_ID\" AS \"CANONICAL_SEGMENT_ID\"\n\tFROM EXTERNAL_ID_MAPPING sids\n\tLEFT JOIN (\n\t\tSELECT \n\t\t\ttraits.\"CANONICAL_SEGMENT_ID\" AS \"CANONICAL_SEGMENT_ID\"\n\t\tFROM \"SEGMENT_EVENTS\".\"DRIVETIME_PROFILE\".\"USER_TRAITS\" AS traits\n\t\t \n\t\t\t\n\t) tra\n\tON sids.\"CANONICAL_SEGMENT_ID\" = tra.\"CANONICAL_SEGMENT_ID\"\n\tWHERE sids.\"EXTERNAL_ID_TYPE\" IN ('android.idfa','email','ios.idfa','user_id')\n\tGROUP BY sids.\"CANONICAL_SEGMENT_ID\"\n), ECG_1 AS (\n\tWITH filtered_query AS (\n\t\tSELECT A.\"CANONICAL_SEGMENT_ID\" AS \"A_CANONICAL_SEGMENT_ID\", B.\"ID\" AS \"B_ID\", B.\"MASTER_PERSON_ID\" AS \"B_MASTER_PERSON_ID\", B.\"PHONENUMBER\" AS \"B_PHONENUMBER\", B.\"PHONE_ISDONOTCONTACT\" AS \"B_PHONE_ISDONOTCONTACT\", B.\"PHONE_PREFERRED\" AS \"B_PHONE_PREFERRED\", B.\"PHONE_TYPE\" AS \"B_PHONE_TYPE\", CONVERT_TIMEZONE('UTC', B.\"RECENT_TIMESTAMP\") AS \"B_RECENT_TIMESTAMP\", B.\"PHONE_ISAUTOMATICCONTACTALLOWED\" AS \"B_PHONE_ISAUTOMATICCONTACTALLOWED\", B.\"VERIFIED\" AS \"B_VERIFIED\"\n\t\tFROM \"SEGMENT_EVENTS\".\"LINKED_EVENTS\".\"EVENT_DATA\" B\n\t\tINNER JOIN EXTERNAL_ID_MAPPING A ON A.\"EXTERNAL_ID_TYPE\" = 'phone' AND A.\"EXTERNAL_ID_VALUE\" = CAST(B.\"PHONENUMBER\" AS VARCHAR)\n\t)\n\tSELECT * FROM filtered_query\n), ECG_1_SEGMENT_ID AS (\n\tSELECT \"A_CANONICAL_SEGMENT_ID\" AS \"CANONICAL_SEGMENT_ID\" FROM ECG_1 GROUP BY \"A_CANONICAL_SEGMENT_ID\"\n), PROFILE_FILTER AS (\n\tSELECT \"CANONICAL_SEGMENT_ID\" FROM PROFILE_TRAITS PT\n\tWHERE (\"CANONICAL_SEGMENT_ID\" IN (SELECT \"CANONICAL_SEGMENT_ID\" FROM ECG_1_SEGMENT_ID))\n), ECG_1_FILTERED AS (\n\tSELECT * FROM ECG_1 WHERE \"A_CANONICAL_SEGMENT_ID\" IN (SELECT \"CANONICAL_SEGMENT_ID\" FROM PROFILE_FILTER)\n)\nSELECT DISTINCT * FROM (\n\tSELECT \"CANONICAL_SEGMENT_ID\" as \"MATCHID\", \"CANONICAL_SEGMENT_ID\", NULL AS \"1_MASTER_PERSON_ID\", NULL AS \"1_PHONENUMBER\", NULL AS \"1_PHONE_ISAUTOMATICCONTACTALLOWED\", NULL AS \"1_PHONE_ISDONOTCONTACT\", NULL AS \"1_PHONE_PREFERRED\", NULL AS \"1_PHONE_TYPE\", NULL AS \"1_RECENT_TIMESTAMP\", NULL AS \"1_VERIFIED\"\n\tFROM PROFILE_FILTER\n\tUNION ALL\n\tSELECT ARRAY_TO_STRING([\"A_CANONICAL_SEGMENT_ID\", '1', REPLACE(CAST(\"B_ID\" AS VARCHAR), ':', '::')], ':') as \"MATCHID\", \"A_CANONICAL_SEGMENT_ID\" as CANONICAL_SEGMENT_ID, \"B_MASTER_PERSON_ID\", \"B_PHONENUMBER\", \"B_PHONE_ISAUTOMATICCONTACTALLOWED\", \"B_PHONE_ISDONOTCONTACT\", \"B_PHONE_PREFERRED\", \"B_PHONE_TYPE\", \"B_RECENT_TIMESTAMP\", \"B_VERIFIED\"\n\tFROM ECG_1_FILTERED WHERE \"B_ID\" IS NOT NULL\n) AS DEDUPED_PROJECTIONS"
  query_identifier_column = "matchId"
  schedule_config         = jsonencode({})
  schedule_strategy       = ""
  source_id               = "9c1DveYoeEj5PU88fW3cb1"
}